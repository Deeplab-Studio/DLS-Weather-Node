<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>DLSWeather Web Installer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script
      type="module"
      src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"
    ></script>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background-color: #f0f2f5;
        padding: 20px;
      }
      .container {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 600px;
        width: 100%;
      }
      h1 {
        margin-top: 0;
        color: #333;
      }
      p {
        color: #666;
        margin-bottom: 2rem;
      }

      .config-box {
        text-align: left;
        margin-top: 30px;
        border-top: 1px solid #eee;
        padding-top: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
      }
      input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      textarea {
        width: 100%;
        height: 120px;
        padding: 10px;
        font-family: monospace;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
        background: #f9f9f9;
      }
      .step {
        font-weight: bold;
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>DLSWeather Installer</h1>
      <p>
        1. Connect your ESP32 via USB.<br />2. Click
        <b>Connect</b> below.<br />3. Select <b>Install DLSWeather</b>.<br />4.
        After installation, click <b>Logs & Console</b>.
      </p>

      <esp-web-install-button manifest="manifest.json"></esp-web-install-button>

      <p
        style="
          margin-top: 10px;
          font-size: 0.85rem;
          color: #d9534f;
          background: #fdf2f2;
          padding: 10px;
          border-radius: 4px;
        "
      >
        <strong>Warning:</strong> "Preparing installation" means the device is
        <strong>Erasing Flash</strong>. This can take
        <strong>10 to 60 seconds</strong> depending on the chip. Please be
        patient and do not disconnect!
      </p>

      <div class="config-box">
        <h3>Configuration Helper</h3>
        <p>
          Enter your details below to generate the commands. then Copy & Paste
          them into the terminal log.
        </p>

        <div class="form-group">
          <label>Wi-Fi SSID</label>
          <input
            type="text"
            id="ssid"
            placeholder="MyWiFiNetwork"
            oninput="updateConfig()"
          />
        </div>
        <div class="form-group">
          <label>Wi-Fi Password</label>
          <input
            type="text"
            id="pass"
            placeholder="SecretPassword"
            oninput="updateConfig()"
          />
        </div>
        <div class="form-group">
          <label>API Key</label>
          <input
            type="text"
            id="key"
            placeholder="YOUR_API_KEY"
            oninput="updateConfig()"
          />
        </div>
        <div class="form-group">
          <label>Station ID</label>
          <input
            type="text"
            id="station"
            placeholder="STATION_001"
            oninput="updateConfig()"
          />
        </div>

        <label>Copy these commands:</label>
        <textarea id="output" readonly></textarea>

        <div style="margin-top: 15px; text-align: right">
          <button
            id="btnSend"
            onclick="sendToDevice()"
            style="
              background: #28a745;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 4px;
              cursor: pointer;
              font-weight: bold;
            "
          >
            Send to Device (Auto-Config)
          </button>
          <p
            id="statusMsg"
            style="font-size: 0.8rem; color: #666; margin-top: 5px"
          ></p>
        </div>
      </div>
    </div>

    <script>
      function updateConfig() {
        const ssid = document.getElementById("ssid").value;
        const pass = document.getElementById("pass").value;
        const key = document.getElementById("key").value;
        const station = document.getElementById("station").value;

        let cmds = "";
        if (ssid) cmds += `ssid=${ssid}\n`;
        if (pass) cmds += `pass=${pass}\n`;
        if (key) cmds += `api=${key}\n`;
        if (station) cmds += `station=${station}\n`;

        if (cmds) cmds += "restart";

        document.getElementById("output").value = cmds;
      }

      async function sendToDevice() {
        const cmds = document.getElementById("output").value;
        if (!cmds) {
          alert("Please fill in the configuration first!");
          return;
        }

        if (!navigator.serial) {
          alert(
            "Web Serial API not supported in this browser. Please use Chrome, Edge or Opera.",
          );
          return;
        }

        const status = document.getElementById("statusMsg");
        let port;

        try {
          status.innerText = "Requesting port...";
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });

          status.innerText = "Connected! Sending data...";

          const encoder = new TextEncoder();
          const writer = port.writable.getWriter();

          // Split by new line and send line by line with delay
          const lines = cmds.split("\n");
          for (const line of lines) {
            if (line.trim() !== "") {
              await writer.write(encoder.encode(line + "\n"));
              // Small delay to ensure ESP32 processes it
              await new Promise((r) => setTimeout(r, 300));
            }
          }

          writer.releaseLock();
          status.innerText = "Configuration sent! Device should restart.";
          status.style.color = "green";

          // Close port after a short while
          setTimeout(async () => {
            await port.close();
            status.innerText = "Port closed.";
            status.style.color = "#666";
          }, 2000);
        } catch (e) {
          console.error(e);
          status.innerText = "Error: " + e.message;
          status.style.color = "red";
        }
      }
    </script>
  </body>
</html>
